DROP FUNCTION public.update_trngantts;

CREATE OR REPLACE FUNCTION public.update_trngantts(tablename regclass, sno character varying, itmcode character varying, itmname character varying, opeitmprocessseq numeric)
 RETURNS TABLE(
 dummy_sno character varying, 
 itm_code_trn character varying, 
 itm_name_trn character varying, 
 trngantt_processseq_trn numeric, 
 id numeric, 
 trngantt_key character varying, 
 trngantt_tblname character varying, 
 trngantt_tblid numeric, 
 trngantt_orgtblname character varying, 
 trngantt_orgtblid numeric, 
 trngantt_paretblname character varying, 
 trngantt_paretblid numeric, 
 trngantt_mlevel numeric, 
 trngantt_itm_id_org numeric, 
 trngantt_loca_id_org numeric,
 trngantt_processseq_org numeric,
 trngantt_duedate_org timestamp without time zone, 
 trngantt_toduedate_org timestamp without time zone, 
 trngantt_starttime_org timestamp without time zone, 
 trngantt_itm_id_pare numeric, 
 trngantt_duedate_pare timestamp without time zone, 
 trngantt_toduedate_pare timestamp without time zone,
 trngantt_starttime_pare timestamp without time zone, 
 trngantt_starttime_trn timestamp without time zone, 
 trngantt_shelfno_id_pare numeric, 
 trngantt_shelfno_id_to_pare numeric, 
 trngantt_qty_pare numeric, 
 itm_code_pare character varying, 
 trngantt_processseq_pare numeric, 
 itm_name_pare character varying,
 trngantt_itm_id_trn numeric,  
 trngantt_mkprdpurord_id_trngantt numeric,
 trngantt_duedate_trn timestamp without time zone, 
 trngantt_toduedate_trn timestamp without time zone, 
 trngantt_shelfno_id_trn numeric, 
 trngantt_shelfno_id_to_trn numeric,
 loca_code_shelfno_trn character varying, 
 loca_name_shelfno_trn character varying, 
 shelfno_code_trn character varying, 
 shelfno_name_trn character varying,
 loca_code_shelfno_pare character varying, 
 loca_name_shelfno_pare character varying, 
 shelfno_code_pare character varying, 
 shelfno_name_pare character varying,
 loca_code_org character varying, 
 loca_name_org character varying, 
 person_code_upd character varying, 
 person_name_upd character varying,
 loca_code_shelfno_to_trn character varying, 
 loca_name_shelfno_to_trn character varying, 
 shelfno_code_to_trn character varying, 
 shelfno_name_to_trn character varying,
 trngantt_prjno_id numeric, 
 trngantt_qty numeric, 
 trngantt_qty_stk numeric, 
 trngantt_qty_handover numeric, 
 trngantt_person_id_upd numeric, 
 trngantt_id numeric, 
 trngantt_consumminqty numeric,
 trngantt_consumunitqty numeric, 
 trngantt_update_ip character varying, 
 trngantt_updated_at timestamp without time zone, 
 trngantt_consumchgoverqty numeric, 
 trngantt_created_at timestamp without time zone, 
 trngantt_qty_sch numeric, 
 trngantt_qty_require numeric, 
 prjno_code character varying, 
 prjno_name character varying, 
 trngantt_expiredate date, 
 trngantt_parenum numeric, 
 trngantt_chilnum numeric,
 trngantt_remark character varying, 
 trngantt_shuffle_flg character, 
 trngantt_consumtype character)
 LANGUAGE plpgsql
AS $function$
BEGIN	
RETURN QUERY 
 	execute 'select $1 dummy_sno,$2 itm_code_trn,$3 itm_name_trn,$4 processseq,
			t.id id,
			t.key trngantt_key,
			t.tblname trngantt_tblname,
			t.tblid trngantt_tblid,
			t.orgtblname trngantt_orgtblname,
            t.orgtblid trngantt_orgtblid,
            t.paretblname trngantt_paretblname,
            t.paretblid trngantt_paretblid,
            t.mlevel trngantt_mlevel,
            t.itms_id_org trngantt_itm_id_org,
            t.locas_id_org trngantt_loca_id_org,
			t.processseq_org trngantt_processseq_org,
			t.duedate_org trngantt_duedate_org,
			t.toduedate_org trngantt_toduedate_org,
			t.starttime_org trngantt_starttime_org,
			t.itms_id_pare trngantt_itm_id_pare,
			t.duedate_pare trngantt_duedate_pare,
            t.toduedate_pare trngantt_toduedate_pare,
			t.starttime_pare trngantt_starttime_pare,
			t.starttime_trn trngantt_starttime_trn,
			t.shelfnos_id_pare trngantt_shelfnos_id_pare,
			t.shelfnos_id_to_pare trngantt_shelfnos_id_to_pare,
			t.qty_pare trngantt_qty_pare,
           	pareitm.code itm_code_pare,
			t.processseq_pare trngantt_processseq_pare,
			pareitm.name itm_name_pare,
			t.itms_id_trn trngantt_itm_id_trn,	
			t.mkprdpurords_id_trngantt trngantt_mkprdpurord_id_trngantt,
			t.duedate_trn trngantt_duedate_trn,
			t.toduedate_trn trngantt_toduedate_trn,
			t.shelfnos_id_trn trngantt_shelfno_id_trn,
 			t.shelfnos_id_to_trn trngantt_shelfno_id_to_trn,
			trnshelfno.loca_code_shelfno_trn  loca_code_shelfno_trn,
			trnshelfno.loca_name_shelfno_trn  loca_name_shelfno_trn,
			trnshelfno.code shelfno_code_trn,
			trnshelfno.name shelfno_name_trn,
			pareshelfno.loca_code_shelfno_pare  loca_code_shelfno_pare,
			pareshelfno.loca_name_shelfno_pare  loca_name_shelfno_pare,
			pareshelfno.code shelfno_code_pare,
			pareshelfno.name shelfno_name_pare,
			orgloca.code loca_code_org,
			orgloca.name locas_name_org,
			upd.code trngantt_person_code_upd,
			upd.name trngantt_person_name_upd,
			trnshelfnoto.loca_code_shelfno_to_trn  loca_code_shelfno_to_trn,
			trnshelfnoto.loca_name_shelfno_to_trn  loca_name_shelfno_to_trn,
			trnshelfnoto.code shelfno_code_to_trn,
			trnshelfnoto.name shelfno_name_to_trn,
			t.prjnos_id trngantt_prjno_id,
			t.qty trngantt_qty,
			t.qty_stk trngantt_qty_stk,
			t.qty_handover trngantt_qty_handover,
			t.persons_id_upd trngantt_person_id_upd,
			t.id trngantt_id,
			t.consumminqty trngantt_consumminqty,
			t.consumunitqty trngantt_consumunitqty,
			t.update_ip trngantt_update_ip,
			t.updated_at trngantt_updated_at,
			t.consumchgoverqty trngantt_consumchgoverqty,
			t.created_at trngantt_created_at,
			t.qty_sch trngantt_qty_sch,
			t.qty_require trngantt_qty_require,
			prjno.code prjno_code,
			prjno.name prjno_name,
			t.expiredate trngantt_expiredate,
			t.parenum trngantt_parenum,
			t.chilnum trngantt_chilnum,
			t.remark trngantt_remark,
			t.shuffleflg trngantt_shuffleflg,
			t.consumtype trngantt_consumtype
		from trngantts t 
		inner join (select a.srctblname,ord.sno,a.trngantts_id from alloctbls a 
					inner join '|| tablename ||' ord on ord.id = a.srctblid 
								and ord.sno = $1 ) alloc on t.id = alloc.trngantts_id 
		inner join itms pareitm on pareitm.id = t.itms_id_pare  
		inner join (select s.*,l.code loca_code_shelfno_trn,l.name loca_name_shelfno_trn
						from shelfnos s inner join locas l on l.id = s.locas_id_shelfno)
					trnshelfno on trnshelfno.id = t.shelfnos_id_trn 
		inner join (select s.*,l.code loca_code_shelfno_to_trn,l.name loca_name_shelfno_to_trn
						from shelfnos s inner join locas l on l.id = s.locas_id_shelfno)
					trnshelfnoto on trnshelfnoto.id = t.shelfnos_id_to_trn  
		inner join (select s.*,l.code loca_code_shelfno_pare,l.name loca_name_shelfno_pare
						from shelfnos s inner join locas l on l.id = s.locas_id_shelfno)
					pareshelfno on pareshelfno.id = t.shelfnos_id_pare
		inner join locas orgloca on orgloca.id = t.locas_id_org
		inner join prjnos prjno on prjno.id = t.prjnos_id
		inner join persons upd on upd.id = t.persons_id_upd
	'
	using sno,itmcode ,itmname ,opeitmprocessseq ;
END
$function$
;
